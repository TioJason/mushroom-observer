<%
  logged_in = !@user.nil? && @user.verified
  consensus = observation.consensus_naming
  any_names = observation.namings && observation.namings.count > 0
  votes = observation.user_votes_by_naming(@user)
  details = @details
%>

<!--TABLE OF NAMES FOR WIDE SCREEN-->
<div class="hidden-xs">
  <%= form_tag(add_query_param(controller: :vote, action: :cast_votes,
      id: observation.id), id: "cast_votes_1") do %>

    <div class="row table-namings">
      <% if details %>
        <div class="col-sm-2 push-down">
          <%= :your_votes.t %>
        </div>
        <div class="col-sm-4 push-down">
          <%= name_header(any_names) %>
        </div>
      <% else %>
        <div class="col-sm-6 push-down">
          <%= name_header(any_names) %>
        </div>
      <% end %>
      <div class="col-sm-2 push-down">
        <%= :DATE.t %>
      </div>
      <div class="col-sm-2 push-down"><%= :show_namings_user.t %></div>
      <div class="col-sm-2 push-down">
        <%= link_with_query(:VOTING.t, {
            action: :show_observation,
            details: true,
            id: observation.id},
            class: "btn pull-right") unless details %>
      </div>
    </div>
    <div class="list-group">
      <% naming_events(observation, details).each do |event| %>
        <% if event.is_a?(Naming) %>
          <%= render(partial: "naming/log_entry",
                     locals: { naming: event,
                               vote: votes[event.id],
                               show_details: details && logged_in,
                               observation: observation,
                               consensus: consensus }) %>
        <% elsif event.is_a?(Vote) %>
          <%= render(partial: "vote/log_entry",
                     locals: { vote: event }) %>
        <% end # if event.is_a?(Naming) %>
      <% end # each_name %>
    </div>
    <div class="row" style="margin: 0; padding-top: 0; padding-bottom: 0">
      <% if details %>
        <div class="col-sm-3">
          <%= submit_tag(:show_namings_update_votes.l,
                         data: {role: "save_votes"},
                         class: "btn push-up") if logged_in && any_names %>
        </div>
      <% end %>
      <div class="col-sm-2">
        <%= link_with_query(:show_namings_add_name.t, {
            controller: :naming,
            action: :create,
            id: observation.id},
            class: "btn push-up") %>
      </div>
      <p class="help-block max-width-text">
        <% if !logged_in %>
            <%= :show_namings_please_login.t %>
        <% end %>
      </p>
    </div>
    <!--/HELP TEXT AND EYES FOR WIDE SCREEN-->
  <% end %>
</div>

<!--TABLE OF NAMES FOR MOBILE-->
<div class="visible-xs">
  <%= form_tag(add_query_param(controller: :vote, action: :cast_votes,
               id: observation.id), id: "cast_votes_2") do %>
    <div class="row visible-xs">
      <div class="col-xs-12">
        <% if any_names %>
          <%= content_tag(:h4, :show_namings_proposed_names.t) %>
          <div class="list-group">
            <% naming_events(observation, details).each do |event| %>
              <% if event.is_a?(Naming) %>
                <% render(partial: "naming/log_entry_xs",
                          locals: { naming: event,
                                    vote: votes[event.id],
                                    show_details: details && logged_in,
                                    observation: observation,
                                    consensus: consensus }) %>
              <% elsif event.is_a?(Vote) %>
                <%= render(partial: "vote/log_entry_xs",
                           locals: { vote: event }) %>
              <% end # if event.is_a?(Naming) %>
            <% end # each_name %>
          </div>
        <% else # any_names %>
          <%= content_tag(:h4, :show_namings_no_names_yet.t) %>
        <% end # any_names %>
      </div>
    </div>
    <!--/TABLE OF NAMES FOR MOBILE-->

    <!--HELP TEXT AND EYES FOR MOBILE-->
    <% if details %>
      <div class="row" style="margin: 0; padding-top: 0; padding-bottom: 0">
        <div class="col-xs-12">
          <div class="pull-right-sm push-down-sm">
            <%= submit_tag(:show_namings_update_votes.l,
                           data: {role: "save_votes"},
                           class: "btn") if logged_in && any_names %>
          </div>
          <p class="help-block max-width-text">
            <% if !logged_in %>
                <%= :show_namings_please_login.t %>
            <% end %>
          </p>
        </div>
      </div>
    <% end %>
    <!--/HELP TEXT AND EYES FOR MOBILE-->
  <% end # form %>
</div>

<!--VOTE POPUPS-->
<div class="row">
  <% observation.namings.select { |naming| naming.votes.count > 0 }.each do |naming|
    @naming = naming %>
    <div class="popup" id="show_votes_<%= naming.id %>" data-role="popup">
      <div class="popup-frame" id="show_votes_<%= naming.id %>_frame">
        <%= render(partial: "vote/show_votes",
                   locals: { do_cancel: true, naming: @naming }) %>
      </div>
    </div>
  <% end %>
</div>
<% inject_javascript_at_end %(
  VotePopupModule('#{j :show_namings_lose_changes.l.gsub("\n", " ")}')
) %>
<!--/VOTE POPUPS-->
